# [fit] Take your monolith
# to *microservices* with Fastify

---

![right 20%](images/companies.png)

# About Us

**Tomas Della Vedova**
Senior Software Engineer - Elastic

**Matteo Collina**
Technical Director - NearForm

---

# [fit] [fastify.rocks/workshop](https://fastify.rocks/workshop)

---

# [fit] Are you using *Node.js* in your daily job?

---

# [fit] Have you ever used *Fastify*?

---
[.background-color: #444752]
![](images/fastify-background.png)

![inline 10%](images/fastify-white-landscape.png)

---

```js
'use strict'

const fastify = require('fastify')()

fastify.get('/', async (req, reply) => {
  return { hello: 'world' }
})

fastify.listen(3000, console.log)
```

---

# Validation

---

# JSON Schema

```js
const schema = {
  body: {
    type: 'object',
    properties: {
      user: { type: 'string' },
      age: { type: 'integer' }
    },
    required: ['user', 'age']
  }
}

fastify.post('/', { schema },  async (req, reply) => {
  return { hello: 'world' }
})
```

---

# Fluent Schema

```js
const S = requrie('fluent-schema')
const schema = S.object()
  .prop('user', S.string()).required()
  .prop('age', S.integer()).required()

fastify.post('/', { schema },  async (req, reply) => {
  return { hello: 'world' }
})
```

---

# Fastify *Plugins*
### A brief overview

---

```js
fastify.register(
  require('my-plugin'),
  { options }
)
```

---

```js
async function myPlugin (fastify, opts) {
  // register other plugins
  fastify.register(...)

  // add hooks
  fastify.addHook(...)

  // add decorator
  fastify.decorate(...)

  // add routes
  fastify.route(...)
}

module.exports = myPlugin
```

---

## Plugins: *Architecture*

![inline 50%](images/dag.png)

---

## Plugins: *Encapsulation*

![inline 50%](images/dag-decorate.png)

---

```js
async function myPlugin (fastify, options) {
  fastify.decorate('util', yourAwesomeUtility)
  // now you can use it with `fastify.util`
}

module.exports = myPlugin
```

---
[.code-highlight: 1,8]

```js
const fp = require('fastify-plugin')

async function myPlugin (fastify, options) {
  fastify.decorate('util', yourAwesomeUtility)
  // now you can use it with `fastify.util`
}

module.exports = fp(myPlugin)
```

---

## Plugins: *Encapsulation*

![inline 50%](images/dag-fp-encapsulate.png)

---

## Plugins: Real world

![inline 50%](images/plugin-real-world.png)

---

### Encapsulation enables cool things

```js
const fastify = require('fastify')()

fastify.register(require('./api/v1'), {
  prefix: '/v1',
  logLevel: 'error'
})

fastify.register(require('./api/v2'), {
  prefix: '/v2',
  logLevel: 'debug'
})
```

---

# [fit] *Everything*
# [fit] is a plugin

---

# [fit] [fastify.io/ecosystem](https://www.fastify.io/ecosystem/)

---

# Let's start*!*

---

# A little bit of configuration
Being *consistent* across microservices is a difficult task,  
to *help you* Fastify provides a powerful CLI.

```bash
npx fastify-cli generate workshop
cd workshop
npm install
```

---

# Project structure
- *app.js*: your entry point;
- *services*: the folder where you will declare all your endpoints;
- *plugins*: the folder where you will store all your custom plugins;
- *test*: the folder where you will declare all your test.

---

# Scripts
- *`npm start`*: run your server;
- *`npm run dev`*: run your server with pretty logs  
(not suitable for production);
- *`npm test`*: run your test suite.

---

# Exercise *0*

Generate the project and run it!

---

# Exercise *1*

Create a simple status service that exposes a status route.
```
GET /status => { status: 'ok' }
```

---

# Testing

```js
'use strict'

const { test } = require('tap')

// the helper is a piece of scaffold
// generated by fastify-cli
const { build } = require('../helper')

test('200 response', async t => {
  const app = await build(t)
  const response = await app.inject({
    method: 'GET',
    url: '/status'
  })

  t.strictEqual(response.statusCode, 200)
  t.deepEqual(JSON.parse(response.payload), { status: 'ok' })
})
```

---

# Exercise *2*

Test your application.

---

# Authentication

Protecting your application is important.

![inline](images/basic-auth-over-plain-http.jpg)

---

# Exercise *3*

Create an authentication plugin that uses [fastify-basic-auth](https://github.com/fastify/fastify-basic-auth).

Create also two fake users to test your application.

```js
const users = {
  arya: 'stark', // Basic YXJ5YTpzdGFyaw==
  jon: 'snow' // Basic am9uOnNub3c=
}
```

---

```js
'use strict'

const fp = require('fastify-plugin')
const basicAuth = require('fastify-basic-auth')

const users = {
  arya: 'stark', // Basic YXJ5YTpzdGFyaw==
  jon: 'snow' // Basic am9uOnNub3c=
}

async function basicAuthPlugin (fastify, opts) {
  fastify.register(basicAuth, { validate })
  fastify.decorateRequest('user', null)

  async function validate (username, password, req, reply) {
    if (users[username] !== password) {
      throw new Error('Invalid username or password')
    }

    req.user = {
      name: username,
      topics: username === 'arya'
        ? ['sword', 'death', 'weapon']
        : ['sword', 'night', 'know']
    }
  }
}

module.exports = fp(basicAuthPlugin)
```

___

# Exercise *4*

Test your plugin.

---
[.code-highlight: 4]

```js
fastify.route({
  method: 'GET',
  path: '/post/:id',
  onRequest: fastify.basicAuth,
  handler: onGetPost
})
```

---

# Exercise *5*

Create a new `/me` route that returns `req.user`.
Add a test.

---

# Let's add our *database*

- npm.im/fastify-elasticsearch
- npm.im/@delvedor/fastify-workshop-dataset

---

```js
module.exports = async function (fastify, opts) {
  fastify.register(
    require('fastify-elasticsearch'),
    { node: 'http://localhost:9200' }
  )

  fastify.register(require('@delvedor/fastify-workshop-dataset'))

  fastify.register(AutoLoad, {
    dir: path.join(__dirname, 'plugins'),
    options: Object.assign({}, opts)
  })

  fastify.register(AutoLoad, {
    dir: path.join(__dirname, 'services'),
    options: Object.assign({}, opts)
  })
}
```

---

# Index a new document in Elasticsearch

```js
await fastify.elastic.index({
  index: 'westeros',
  id: 'stark-house'
  body: {
    house: 'Stark',
    motto: 'Winter is coming',
    region: 'north'
  }  
})
```

---
[.autoscale: true]

# Exercise *6*

Create an endpoint to index a new tweet,  
the endpoint should return the tweet id.  
**Bonus:** Add route validation.

You can use [Hyperid](http://npmjs.com/package/hyperid) for generating the IDs.

```
{
  id: String,
  text: String,
  user: String,
  time: DateString,
  topics: String[]
}
```

---

# Exercise *7*

Test your application.

---

# Get a document by id in Elasticsearch

```js
const { body } = await fastify.elastic.get({
  index: 'westeros',
  id: 'stark-house'
})

console.log(body._source)
```

---

# Exercise *8*

Create an endpoint to get a tweet by id.  
**Bonus:** Add route validation.

```
GET /tweet/:id => {
                    id: String,
                    text: String,
                    user: String,
                    time: DateString,
                    topics: String[]
                  }
```

---

# Exercise *9*

Test your application.

---

# Search documents ordered by time in Elasticsearch

```js
const { body } = await fastify.elastic.search({
  index: 'westeros',
  query: { match_all: {} },
  sort: { time: { order: 'desc' } }
})

const docs = body.hits.hits.map(h => h._source)
console.log(docs)
```

---

# Exercise *10*

Create an endpoint to get a tweet timeline, ordered by time.  
**Bonus:** Boost the results with a given topic.

```
GET /timeline => [{
                    id: String,
                    text: String,
                    user: String,
                    time: DateString,
                    topics: String[]
                 }]
```

---

```js
const filterTopics = req.user.topics.map(t => {
  return {
    filter: {
      term: { topics: t }
    },
    weight: 5
  }
})

const query = {
  query: {
    function_score: {
      query: {
        match_all: {}
      },
      functions: [
        {
          gauss: {
            time: {
              origin: 'now',
              scale: '4h',
              offset: '2h',
              decay: 0.5
            }
          }
        },
        ...filterTopics
      ],
      boost_mode: 'multiply'
    }
  },
  size: 10,
  from: req.query.from || 0
}
```

---

# Exercise *11*

Test your application.

---

# Let's talk about *observability*

```
npm i elastic-apm-node
```

---

```json
{
  "dev": "fastify start -l info -P app.js",
  "apm": "NODE_OPTIONS=\"-r elastic-apm-node/start\"
            fastify start -l info app.js"
}
```

---

# Exercise *12*

Open Kibana and run your application with APM.

```
http://localhost:5601
```

---

![inline 70%](images/kibana-apm.png)

---

# From monolith<br/>to *microservices*
### Let's begin*!*

---

# Exercise *13*

- *Duplicate* the project three time
- Keep only *one service* per project
- *Run* the services!

---

# Awesome!
Now update *all your clients* so they know  
which address to call based on the service they need to use.

![inline](images/clients.gif)

---

# [fit] *WRONG!*

---

# The infrastructure<br/>should be *transparent*<br/>to the client.

---

# Exercise *14*

How can we fix this?

---

```js
'use strict'

const fastify = require('fastify')({ logger: true })
const proxy = require('fastify-http-proxy')

fastify.register(proxy, {
  upstream: 'http://localhost:3030',
  prefix: '/post'
})

fastify.register(proxy, {
  upstream: 'http://localhost:3031',
  prefix: '/me'
})

fastify.register(proxy, {
  upstream: 'http://localhost:3032',
  prefix: '/timeline'
})

fastify.listen(3000)
```

---

[.background-color: #444752]
![](images/fastify-background.png)

![inline 10%](images/fastify-white-landscape.png)

---

![right 20%](images/companies.png)

# [fit] Thanks*!*

Tomas Della Vedova - [@delvedor](https://twitter.com/delvedor)

Matteo Collina - [@matteocollina](https://twitter.com/matteocollina)
